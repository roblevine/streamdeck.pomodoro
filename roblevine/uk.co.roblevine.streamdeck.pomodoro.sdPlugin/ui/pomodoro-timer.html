<!DOCTYPE html>
<html>

<head lang="en">
    <title>Pomodoro Timer Settings</title>
    <meta charset="utf-8" />
    <script src="https://sdpi-components.dev/releases/v4/sdpi-components.js"></script>
    <script>
        // Custom WebSocket for preview messages (separate from sdpi-components)
        let previewWebsocket = null;
        let pluginUUID = null;

        // Hook into the connection to get the port and UUID, but don't interfere with sdpi-components
        (function() {
            const script = document.createElement('script');
            script.textContent = `
                (function() {
                    const originalConnect = window.connectElgatoStreamDeckSocket;
                    window.connectElgatoStreamDeckSocket = function(inPort, inPluginUUID, inRegisterEvent, inInfo, inActionInfo) {
                        // Call sdpi-components' original handler first
                        if (originalConnect) {
                            originalConnect.apply(this, arguments);
                        }

                        // Store UUID for our preview messages
                        window.__previewPluginUUID = inPluginUUID;
                        window.__previewPort = inPort;

                        // Setup our preview WebSocket connection
                        if (window.initPreviewWebSocket) {
                            window.initPreviewWebSocket(inPort, inPluginUUID);
                        }
                    };
                })();
            `;
            document.head.appendChild(script);
        })();

        // Track playback state
        const playbackState = {
            work: false,
            break: false
        };

        // Initialize preview WebSocket
        window.initPreviewWebSocket = function(port, uuid) {
            pluginUUID = uuid;
            previewWebsocket = new WebSocket('ws://127.0.0.1:' + port);

            previewWebsocket.onopen = function() {
                const json = {
                    event: 'registerPropertyInspector',
                    uuid: pluginUUID
                };
                previewWebsocket.send(JSON.stringify(json));
            };

            previewWebsocket.onmessage = function(evt) {
                const data = JSON.parse(evt.data);
                console.log('Received message from plugin:', data);

                // Handle playback status messages from plugin
                if (data.event === 'sendToPropertyInspector' || data.event === 'sendToPropertyInspector') {
                    const payload = data.payload;
                    console.log('Payload:', payload);

                    if (payload && payload.event === 'playbackStarted') {
                        console.log('Playback started:', payload.playbackId);
                        updateButtonState(payload.playbackId, true);
                    } else if (payload && payload.event === 'playbackStopped') {
                        console.log('Playback stopped:', payload.playbackId);
                        updateButtonState(payload.playbackId, false);
                    }
                }
            };
        };

        // Update button state based on playback
        function updateButtonState(playbackId, isPlaying) {
            if (playbackId === 'work-preview') {
                playbackState.work = isPlaying;
                const button = document.querySelector('#workPreviewBtn');
                if (button) {
                    button.textContent = isPlaying ? 'Stop' : 'Preview';
                }
            } else if (playbackId === 'break-preview') {
                playbackState.break = isPlaying;
                const button = document.querySelector('#breakPreviewBtn');
                if (button) {
                    button.textContent = isPlaying ? 'Stop' : 'Preview';
                }
            }
        }

        // Helper to send preview messages to plugin
        function sendToPlugin(payload) {
            if (previewWebsocket && previewWebsocket.readyState === WebSocket.OPEN && pluginUUID) {
                const json = {
                    event: 'sendToPlugin',
                    context: pluginUUID,
                    payload: payload
                };
                previewWebsocket.send(JSON.stringify(json));
            }
        }
    </script>
</head>

<body>
    <sdpi-item label="Work Duration (mm:ss)">
        <sdpi-textfield setting="workDuration" type="text" pattern="\d{1,3}:\d{2}" value="25:00" placeholder="25:00"></sdpi-textfield>
    </sdpi-item>
    <sdpi-item label="Short Break Duration (mm:ss)">
        <sdpi-textfield setting="shortBreakDuration" type="text" pattern="\d{1,3}:\d{2}" value="5:00" placeholder="5:00"></sdpi-textfield>
    </sdpi-item>
    <sdpi-item label="Long Break Duration (mm:ss)">
        <sdpi-textfield setting="longBreakDuration" type="text" pattern="\d{1,3}:\d{2}" value="15:00" placeholder="15:00"></sdpi-textfield>
    </sdpi-item>
    <sdpi-item label="Cycles Before Long Break">
        <sdpi-textfield setting="cyclesBeforeLongBreak" type="number" min="1" max="10" value="4" placeholder="4"></sdpi-textfield>
    </sdpi-item>
    <sdpi-item label="Enable Sound">
        <sdpi-checkbox setting="enableSound" value="true"></sdpi-checkbox>
    </sdpi-item>
    <sdpi-item label="Work End Sound (.wav)">
        <sdpi-file id="workSoundFile" setting="workEndSoundPath" accept=".wav" placeholder="Select work period end sound"></sdpi-file>
        <sdpi-button id="workPreviewBtn" onclick="previewWorkSound()">Preview</sdpi-button>
    </sdpi-item>
    <sdpi-item label="Break End Sound (.wav)">
        <sdpi-file id="breakSoundFile" setting="breakEndSoundPath" accept=".wav" placeholder="Select break end sound"></sdpi-file>
        <sdpi-button id="breakPreviewBtn" onclick="previewBreakSound()">Preview</sdpi-button>
    </sdpi-item>
    <sdpi-item label="Info">
        <span>Configure your Pomodoro cycle. Enter durations in mm:ss format (e.g., 25:00 for 25 minutes). Default: 25:00 work, 5:00 short break, 15:00 long break after 4 cycles. Press the button to start or stop the timer.</span>
    </sdpi-item>

    <script>
        // Global functions for button clicks
        window.previewWorkSound = function() {
            if (playbackState.work) {
                // Stop playback
                updateButtonState('work-preview', false);
                sendToPlugin({
                    action: 'stopSound',
                    playbackId: 'work-preview'
                });
            } else {
                // Start playback
                const fileInput = document.getElementById('workSoundFile');
                const filePath = fileInput?.value;

                if (filePath) {
                    // Optimistically update UI
                    updateButtonState('work-preview', true);

                    sendToPlugin({
                        action: 'previewSound',
                        filePath: filePath,
                        playbackId: 'work-preview'
                    });

                    // Reset button after a reasonable timeout (assume audio finished)
                    setTimeout(() => {
                        if (playbackState.work) {
                            updateButtonState('work-preview', false);
                        }
                    }, 5000); // 5 second timeout
                }
            }
        };

        window.previewBreakSound = function() {
            if (playbackState.break) {
                // Stop playback
                updateButtonState('break-preview', false);
                sendToPlugin({
                    action: 'stopSound',
                    playbackId: 'break-preview'
                });
            } else {
                // Start playback
                const fileInput = document.getElementById('breakSoundFile');
                const filePath = fileInput?.value;

                if (filePath) {
                    // Optimistically update UI
                    updateButtonState('break-preview', true);

                    sendToPlugin({
                        action: 'previewSound',
                        filePath: filePath,
                        playbackId: 'break-preview'
                    });

                    // Reset button after a reasonable timeout (assume audio finished)
                    setTimeout(() => {
                        if (playbackState.break) {
                            updateButtonState('break-preview', false);
                        }
                    }, 5000); // 5 second timeout
                }
            }
        };
    </script>
</body>

</html>